name: Deploy to production

on:
  workflow_dispatch: {}

env:
  # Non-secret config comes from GitHub variables so it can be changed without editing this file
  AWS_REGION: ${{ vars.AWS_REGION }}
  ECR_BACKEND_REPO: ${{ vars.ECR_BACKEND_REPO }}
  ECR_FRONTEND_REPO: ${{ vars.ECR_FRONTEND_REPO }}
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-push:
    name: Build and push Docker images to ECR
    runs-on: ubuntu-latest
    environment: prod

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push backend image
        run: |
          docker build -f apps/backend/Dockerfile.prod -t $ECR_BACKEND_REPO:$IMAGE_TAG apps/backend
          docker push $ECR_BACKEND_REPO:$IMAGE_TAG

      - name: Build and push frontend image
        run: |
          docker build -f apps/frontend/Dockerfile.prod -t $ECR_FRONTEND_REPO:$IMAGE_TAG apps/frontend
          docker push $ECR_FRONTEND_REPO:$IMAGE_TAG

  deploy:
    name: Deploy on EC2 using docker-compose.production.yml
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: prod
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ vars.AWS_REGION }}

    steps:
      - name: SSH to EC2 and deploy
        uses: appleboy/ssh-action@v1.0.0
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ vars.AWS_REGION }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: AWS_ACCESS_KEY_ID,AWS_SECRET_ACCESS_KEY,AWS_REGION
          script: |
            set -e
            echo "Starting deployment..."

            # Setup directory
            sudo mkdir -p /opt/wedding-gallery
            sudo chown "$USER":"$USER" /opt/wedding-gallery
            cd /opt/wedding-gallery

            # Ensure Docker is installed
            if ! command -v docker >/dev/null 2>&1; then
              echo "Installing Docker..."
              
              if command -v yum >/dev/null 2>&1; then
                # Amazon Linux installation
                sudo yum install -y docker
                sudo systemctl start docker
                sudo systemctl enable docker
                sudo usermod -aG docker "$USER"
              elif command -v apt-get >/dev/null 2>&1; then
                # Ubuntu/Debian installation
                sudo apt-get update -qq
                sudo apt-get install -y ca-certificates curl gnupg lsb-release
                
                # Add Docker's official GPG key
                sudo mkdir -p /etc/apt/keyrings
                curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg 2>/dev/null || \
                  curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
                
                # Set up the repository
                ARCH="$(dpkg --print-architecture 2>/dev/null || echo amd64)"
                CODENAME="$(lsb_release -cs 2>/dev/null || echo jammy)"
                echo \
                  "deb [arch=${ARCH} signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
                  ${CODENAME} stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
                
                # Install Docker Engine
                sudo apt-get update -qq
                sudo apt-get install -y docker-ce docker-ce-cli containerd.io
                
                # Start and enable Docker
                sudo systemctl start docker
                sudo systemctl enable docker
                sudo usermod -aG docker "$USER"
              else
                echo "Error: Cannot determine package manager (yum/apt-get not found)"
                exit 1
              fi
              
              echo "Docker installed successfully"
            fi
            
            # Ensure Docker service is running
            if ! sudo systemctl is-active --quiet docker; then
              echo "Starting Docker service..."
              sudo systemctl start docker
            fi
            
            # Ensure docker-compose is installed
            if ! command -v docker-compose >/dev/null 2>&1; then
              echo "Installing docker-compose..."
              sudo curl -L "https://github.com/docker/compose/releases/download/v2.29.2/docker-compose-$(uname -s)-$(uname -m)" \
                -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
            fi

            # Ensure AWS CLI is installed
            if ! command -v aws >/dev/null 2>&1; then
              echo "Installing AWS CLI..."
              
              # Install unzip if not present (required for AWS CLI installation)
              if ! command -v unzip >/dev/null 2>&1; then
                echo "Installing unzip..."
                if command -v yum >/dev/null 2>&1; then
                  sudo yum install -y unzip
                elif command -v apt-get >/dev/null 2>&1; then
                  sudo apt-get update -qq && sudo apt-get install -y unzip
                else
                  echo "Error: Cannot determine package manager (yum/apt-get not found)"
                  exit 1
                fi
              fi
              
              # Detect architecture and install AWS CLI v2
              ARCH="$(uname -m)"
              [ "$ARCH" = "x86_64" ] && ARCH="x86_64" || ARCH="aarch64"
              curl -sSL "https://awscli.amazonaws.com/awscli-exe-linux-${ARCH}.zip" -o /tmp/awscliv2.zip
              unzip -q /tmp/awscliv2.zip -d /tmp
              sudo /tmp/aws/install
              rm -rf /tmp/awscliv2.zip /tmp/aws
              echo "AWS CLI installed successfully"
            fi

            # Login to ECR
            ECR_REGISTRY="$(echo "${{ env.ECR_BACKEND_REPO }}" | cut -d'/' -f1)"
            ECR_REGION="$(echo "$ECR_REGISTRY" | cut -d'.' -f4)"
            
            echo "Logging into ECR..."
            aws ecr get-login-password --region "$ECR_REGION" | sudo docker login --username AWS --password-stdin "$ECR_REGISTRY"

            # Update code
            if [ ! -d .git ]; then
              git clone https://github.com/${{ github.repository }} .
            else
              git pull origin main
            fi

            # Create environment files
            mkdir -p apps/backend apps/frontend
            
            cat > apps/backend/.env.production << 'EOF'
            ${{ secrets.BACKEND_ENV_PROD }}
            EOF
            
            cat > apps/frontend/.env.production << 'EOF'
            ${{ secrets.FRONTEND_ENV_PROD }}
            EOF
            
            cat > .env << EOF
            BACKEND_IMAGE=${{ env.ECR_BACKEND_REPO }}:${{ env.IMAGE_TAG }}
            FRONTEND_IMAGE=${{ env.ECR_FRONTEND_REPO }}:${{ env.IMAGE_TAG }}
            EOF

            # Deploy with docker-compose
            echo "Stopping and removing existing containers..."
            sudo docker-compose -f docker-compose.production.yml down -v || true
            
            # Remove containers by name if they still exist (handles orphaned containers)
            sudo docker rm -f wedding-gallery-backend-prod wedding-gallery-frontend-prod 2>/dev/null || true

            echo "Pulling images..."
            sudo docker-compose -f docker-compose.production.yml pull

            echo "Starting services..."
            sudo docker-compose -f docker-compose.production.yml up -d --remove-orphans

            echo "Running migrations..."
            sudo docker-compose -f docker-compose.production.yml exec -T backend python manage.py migrate --noinput

            echo "Seeding initial data..."
            sudo docker-compose -f docker-compose.production.yml exec -T backend python manage.py seed_data

            echo "Deployment complete!"