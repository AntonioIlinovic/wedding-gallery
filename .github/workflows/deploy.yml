name: Deploy to production

on:
  workflow_dispatch: {}

env:
  # Non-secret config comes from GitHub variables so it can be changed without editing this file
  AWS_REGION: ${{ vars.AWS_REGION }}
  ECR_BACKEND_REPO: ${{ vars.ECR_BACKEND_REPO }}
  ECR_FRONTEND_REPO: ${{ vars.ECR_FRONTEND_REPO }}
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-push:
    name: Build and push Docker images to ECR
    runs-on: ubuntu-latest
    environment: prod

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push backend image
        run: |
          docker build -t $ECR_BACKEND_REPO:$IMAGE_TAG apps/backend
          docker push $ECR_BACKEND_REPO:$IMAGE_TAG

      - name: Build and push frontend image
        run: |
          docker build -t $ECR_FRONTEND_REPO:$IMAGE_TAG apps/frontend
          docker push $ECR_FRONTEND_REPO:$IMAGE_TAG

  deploy:
    name: Deploy on EC2 using docker-compose.production.yml
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: prod

    steps:
      - name: SSH to EC2 and deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e

            # Ensure application directory exists and is owned by current user
            sudo mkdir -p /opt/wedding-gallery
            sudo chown "$USER":"$USER" /opt/wedding-gallery
            cd /opt/wedding-gallery

            # Clone repo on first deploy, otherwise pull latest code
            if [ ! -d .git ]; then
              git clone https://github.com/${{ github.repository }} .
            else
              git pull origin main
            fi

            # Write backend .env.production from GitHub secret
            mkdir -p apps/backend
            cat > apps/backend/.env.production << 'EOF'
            ${{ secrets.BACKEND_ENV_PROD }}
            EOF

            # Write frontend .env.production from GitHub secret
            mkdir -p apps/frontend
            cat > apps/frontend/.env.production << 'EOF'
            ${{ secrets.FRONTEND_ENV_PROD }}
            EOF

            # Export image tags for docker compose
            export BACKEND_IMAGE=${{ env.ECR_BACKEND_REPO }}:${{ env.IMAGE_TAG }}
            export FRONTEND_IMAGE=${{ env.ECR_FRONTEND_REPO }}:${{ env.IMAGE_TAG }}

            # Pull and start containers
            docker compose -f docker-compose.production.yml up -d --remove-orphans

            # Run database migrations
            docker compose -f docker-compose.production.yml exec backend python manage.py migrate --noinput