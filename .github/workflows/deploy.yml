name: Deploy to production

on:
  workflow_dispatch: {}

env:
  # Non-secret config comes from GitHub variables so it can be changed without editing this file
  AWS_REGION: ${{ vars.AWS_REGION }}
  ECR_BACKEND_REPO: ${{ vars.ECR_BACKEND_REPO }}
  ECR_FRONTEND_REPO: ${{ vars.ECR_FRONTEND_REPO }}
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-push:
    name: Build and push Docker images to ECR
    runs-on: ubuntu-latest
    environment: prod

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push backend image
        run: |
          docker build -t $ECR_BACKEND_REPO:$IMAGE_TAG apps/backend
          docker push $ECR_BACKEND_REPO:$IMAGE_TAG

      - name: Build and push frontend image
        run: |
          docker build -t $ECR_FRONTEND_REPO:$IMAGE_TAG apps/frontend
          docker push $ECR_FRONTEND_REPO:$IMAGE_TAG

  deploy:
    name: Deploy on EC2 using docker-compose.production.yml
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: prod
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ vars.AWS_REGION }}

    steps:
      - name: SSH to EC2 and deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: AWS_ACCESS_KEY_ID,AWS_SECRET_ACCESS_KEY,AWS_REGION
          script: |
            set -e

            # Ensure Docker is installed and running
            if ! command -v docker >/dev/null 2>&1; then
              if command -v yum >/dev/null 2>&1; then
                sudo yum update -y
                sudo amazon-linux-extras install docker -y || sudo yum install -y docker
                sudo systemctl enable docker
                sudo systemctl start docker
              elif command -v apt-get >/dev/null 2>&1; then
                sudo apt-get update -y
                sudo apt-get install -y docker.io
                sudo systemctl enable docker || true
                sudo systemctl start docker
              fi
            fi

            # Ensure AWS CLI is installed (for ECR login)
            if ! command -v aws >/dev/null 2>&1; then
              if command -v yum >/dev/null 2>&1; then
                sudo yum install -y awscli
              elif command -v apt-get >/dev/null 2>&1; then
                sudo apt-get update -y
                sudo apt-get install -y awscli
              fi
            fi

            # Ensure docker compose / docker-compose is available
            COMPOSE_CMD="docker compose"
            if ! docker compose version >/dev/null 2>&1; then
              if command -v docker-compose >/dev/null 2>&1; then
                COMPOSE_CMD="docker-compose"
              else
                # Fallback: install docker-compose v1
                sudo curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" \
                  -o /usr/local/bin/docker-compose
                sudo chmod +x /usr/local/bin/docker-compose
                COMPOSE_CMD="docker-compose"
              fi
            fi

            # Ensure application directory exists and is owned by current user
            sudo mkdir -p /opt/wedding-gallery
            sudo chown "$USER":"$USER" /opt/wedding-gallery
            cd /opt/wedding-gallery

            # Log in Docker on EC2 to ECR so pulls for private images work
            # Derive registry host and region directly from the ECR repo URL to avoid region mismatches
            ECR_BACKEND_REPO="${{ env.ECR_BACKEND_REPO }}"
            ECR_REGISTRY="$(echo "$ECR_BACKEND_REPO" | cut -d'/' -f1)"          # 528160042133.dkr.ecr.eu-central-1.amazonaws.com
            ECR_REGION="$(echo "$ECR_REGISTRY" | cut -d'.' -f4)"                # eu-central-1
            echo "Logging into ECR registry: $ECR_REGISTRY (region: $ECR_REGION)"
            aws ecr get-login-password --region "$ECR_REGION" | sudo docker login --username AWS --password-stdin "$ECR_REGISTRY"

            # Clone repo on first deploy, otherwise pull latest code
            if [ ! -d .git ]; then
              git clone https://github.com/${{ github.repository }} .
            else
              git pull origin main
            fi

            # Write backend .env.production from GitHub secret
            mkdir -p apps/backend
            cat > apps/backend/.env.production << 'EOF'
            ${{ secrets.BACKEND_ENV_PROD }}
            EOF

            # Write frontend .env.production from GitHub secret
            mkdir -p apps/frontend
            cat > apps/frontend/.env.production << 'EOF'
            ${{ secrets.FRONTEND_ENV_PROD }}
            EOF

            # Write .env file for docker compose with image tags
            cat > .env << EOF
            BACKEND_IMAGE=${{ env.ECR_BACKEND_REPO }}:${{ env.IMAGE_TAG }}
            FRONTEND_IMAGE=${{ env.ECR_FRONTEND_REPO }}:${{ env.IMAGE_TAG }}
            EOF

            # Pull and start containers (needs root to talk to docker daemon)
            sudo $COMPOSE_CMD -f docker-compose.production.yml up -d --remove-orphans

            # Run database migrations
            sudo $COMPOSE_CMD -f docker-compose.production.yml exec backend python manage.py migrate --noinput