name: Test SSH Connection

on:
  workflow_dispatch: {}

jobs:
  test-ssh:
    name: Test SSH to EC2
    runs-on: ubuntu-latest

    steps:
      - name: Check secrets are set
        run: |
          if [ -z "${{ secrets.EC2_HOST }}" ]; then
            echo "❌ EC2_HOST secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.EC2_USER }}" ]; then
            echo "❌ EC2_USER secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.EC2_SSH_KEY }}" ]; then
            echo "❌ EC2_SSH_KEY secret is not set"
            exit 1
          fi
          echo "✓ All required secrets are set"

      - name: Test SSH and create secret files
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "✓ SSH Connection Successful!"
            echo "User: $(whoami)"
            echo "Directory: $(pwd)"
            
            # Create test directory
            mkdir -p ~/ssh-test
            cd ~/ssh-test
            
            # Create files for each secret
            echo "${{ secrets.AWS_ACCESS_KEY_ID }}" > aws_access_key_id.txt
            echo "${{ secrets.AWS_SECRET_ACCESS_KEY }}" > aws_secret_access_key.txt
            echo "${{ secrets.BACKEND_ENV_PROD }}" > backend_env_prod.txt
            echo "${{ secrets.FRONTEND_ENV_PROD }}" > frontend_env_prod.txt
            echo "${{ secrets.EC2_HOST }}" > ec2_host.txt
            echo "${{ secrets.EC2_USER }}" > ec2_user.txt
            
            # Show results
            echo ""
            echo "Files created in ~/ssh-test:"
            ls -lh ~/ssh-test
            
            echo ""
            echo "To cleanup: rm -rf ~/ssh-test"

